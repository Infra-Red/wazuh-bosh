#!/bin/bash

set -e # exit immediately if a simple command exits with a non-zero status
set -u # report the usage of uninitialized variables

RUN_DIR=/var/vcap/sys/run/wazuh-api
PID_FILE=${RUN_DIR}/wazuh-api.pid
LOG_DIR=/var/vcap/sys/log/wazuh-api
JOB_NAME=wazuh-api

case $1 in

  start)

    # Kick off ntpd
    mkdir -p $RUN_DIR
    mkdir -p $LOG_DIR
    chown -R vcap:vcap $RUN_DIR
    chown -R vcap:vcap $LOG_DIR

    # ntpd is on stemcell by default
    exec /var/vcap/packages/nodejs/node/bin/node \
      /var/vcap/packages/wazuh-api/api/app.js \
      >>$LOG_DIR/$JOB_NAME.log 2>&1
    ;;

  stop)
    if [ -f $PID_FILE ]; then
      pid=$(cat $PID_FILE)
      kill -TERM $pid
      sleep 1
      kill -KILL $pid
      rm -f $PID_FILE
    fi

    ;;

  *)
    echo "Usage: ctl {start|stop}" ;;

esac

