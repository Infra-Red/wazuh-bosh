echo "Starting packaging..."

exec 2>&1
set -e
set -u
set -x

# Detect # of CPUs so make jobs can be parallelized
CPUS=$(grep -c ^processor /proc/cpuinfo)
export HOME=/var/vcap

export WAZUH_VERSION="wazuh-server-3.0.0"
export WAZUH_VERSION_TAR="wazuh-3.0"
export USER_DIR=${BOSH_INSTALL_TARGET}/${WAZUH_VERSION}

echo "Untar into ${BOSH_INSTALL_TARGET}"
tar xzvf wazuh-server/wazuh-server-${VERSION}.tar.gz -C ${BOSH_INSTALL_TARGET}

echo "Compiling code and installing..."
cd ${USER_DIR}/${WAZUH_VERSION_TAR}/src
make -j${CPUS} PREFIX=${USER_DIR} TARGET=server