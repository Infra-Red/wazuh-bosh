echo "Starting packaging..."

exec 2>&1
set -e
set -u
set -x

# Detect # of CPUs so make jobs can be parallelized
CPUS=$(grep -c ^processor /proc/cpuinfo)
export HOME=/var/vcap

export WAZUH_FOLDER="wazuh-3.10.2"

echo "Untar into ${BOSH_INSTALL_TARGET}"
mkdir -p ${BOSH_INSTALL_TARGET}

tar xzvf wazuh/${WAZUH_FOLDER}.tar.gz -C ${BOSH_INSTALL_TARGET}

mv ${BOSH_INSTALL_TARGET}/${WAZUH_FOLDER} ${BOSH_INSTALL_TARGET}/source_code

echo "Compiling code and installing..."
cd ${BOSH_INSTALL_TARGET}/source_code/src
make clean
make -j${CPUS} PREFIX=${BOSH_INSTALL_TARGET} TARGET=server USE_SELINUX=0 USE_AUDIT=0 DISABLE_SHARED=1
